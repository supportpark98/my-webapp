<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Drive API Quickstart</title>
  <style>
    #canvas {
      border: 1px solid black;
    }
    .quantity-input {
      width: 30px;
    }
    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>
</head>
<body>
  <p>Drive API Quickstart</p>

  <button id="authorize_button" onclick="handleAuthClick()" aria-label="Authorize">Authorize</button>
  <button id="signout_button" onclick="handleSignoutClick()" aria-label="Sign Out">Sign Out</button>

  <div id="main_product">
    <h3>본품 1을 골라주세요</h3>
    <select id="main_product_selector1"></select>
    <select id="main_product_ratio1"></select>
    <button onclick="displayProduct(1, 'main')" aria-label="본품 1 확인">확인</button>
    <button onclick="selectProduct(1, 'main')" aria-label="본품 1 위치 수정">위치 수정</button>

    <h3>본품 2을 골라주세요</h3>
    <select id="main_product_selector2"></select>
    <select id="main_product_ratio2"></select>
    <button onclick="displayProduct(2, 'main')" aria-label="본품 2 확인">확인</button>
    <button onclick="selectProduct(2, 'main')" aria-label="본품 2 위치 수정">위치 수정</button>

    <h3>본품 3을 골라주세요</h3>
    <select id="main_product_selector3"></select>
    <select id="main_product_ratio3"></select>
    <button onclick="displayProduct(3, 'main')" aria-label="본품 3 확인">확인</button>
    <button onclick="selectProduct(3, 'main')" aria-label="본품 3 위치 수정">위치 수정</button>
  </div>

  <div id="gift_product">
    <h3>증정품 1을 골라주세요</h3>
    <select id="gift_type_selector1" onchange="handleGiftTypeChange(1)">
      <option value="">없음</option>
      <option value="1">1. TS</option>
      <option value="2">2. DLX</option>
      <option value="3">3. SC</option>
    </select>
    <select id="gift_product_selector1"></select>
    <select id="gift_product_ratio1"></select>
    <input type="number" id="gift_quantity1" min="1" placeholder="수량" class="quantity-input">
    <button onclick="displayProduct(1, 'gift')" aria-label="증정품 1 확인">확인</button>
    <button onclick="selectProduct(1, 'gift')" aria-label="증정품 1 위치 수정">위치 수정</button>

    <h3>증정품 2을 골라주세요</h3>
    <select id="gift_type_selector2" onchange="handleGiftTypeChange(2)">
      <option value="">없음</option>
      <option value="1">1. TS</option>
      <option value="2">2. DLX</option>
      <option value="3">3. SC</option>
    </select>
    <select id="gift_product_selector2"></select>
    <select id="gift_product_ratio2"></select>
    <input type="number" id="gift_quantity2" min="1" placeholder="수량" class="quantity-input">
    <button onclick="displayProduct(2, 'gift')" aria-label="증정품 2 확인">확인</button>
    <button onclick="selectProduct(2, 'gift')" aria-label="증정품 2 위치 수정">위치 수정</button>

    <h3>증정품 3을 골라주세요</h3>
    <select id="gift_type_selector3" onchange="handleGiftTypeChange(3)">
      <option value="">없음</option>
      <option value="1">1. TS</option>
      <option value="2">2. DLX</option>
      <option value="3">3. SC</option>
    </select>
    <select id="gift_product_selector3"></select>
    <select id="gift_product_ratio3"></select>
    <input type="number" id="gift_quantity3" min="1" placeholder="수량" class="quantity-input">
    <button onclick="displayProduct(3, 'gift')" aria-label="증정품 3 확인">확인</button>
    <button onclick="selectProduct(3, 'gift')" aria-label="증정품 3 위치 수정">위치 수정</button>
  </div>

  <button onclick="resetAll()" aria-label="초기화">초기화</button>

  <canvas id="canvas" width="300" height="300"></canvas>

  <pre id="content" style="white-space: pre-wrap;"></pre>
  <div id="selection_message"></div>

  <script type="text/javascript">
    const CLIENT_ID = '888045994195-72bc9t9j9ms022nd2evfq0cfthrajqjp.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBFObap5GFgCLBpsQTFFuLx8qMyTWiZ6YM';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    document.getElementById('authorize_button').style.visibility = 'hidden';
    document.getElementById('signout_button').style.visibility = 'hidden';

    const giftTypeToFolderId = {
      '1': '173TTRzelK-SXZaBXzrJOC31f9izyUyxo',
      '2': '1aiwrAEySie43JHGsaZUOeEv3cK9IQuFu',
      '3': '1Tin54hFiR88BiJS2VCwFyPeOCnqN2jiO'
    };

    let mainProductImages = [null, null, null];
    let giftProductImages = [null, null, null];
    let giftQuantities = [0, 0, 0];
    let selectedImageIndex = null; 
    let isEditing = false; 

    const mainProductPositions = [
      { x: 37, y: 190 },
      { x: 75, y: 190 },
      { x: 112, y: 190 }
    ];

    const giftProductPositions = [
      { x: 175, y: 200 },
      { x: 212, y: 200 },
      { x: 249, y: 200 }
    ];

    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.visibility = 'visible';
      }
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        document.getElementById('signout_button').style.visibility = 'visible';
        document.getElementById('authorize_button').innerText = 'Refresh';
        await listFilesInFolder('1m3dw2iTMJy2sn5hiAgIbvmNlNcJm02yV', 'main_product_selector1');
        await listFilesInFolder('1m3dw2iTMJy2sn5hiAgIbvmNlNcJm02yV', 'main_product_selector2');
        await listFilesInFolder('1m3dw2iTMJy2sn5hiAgIbvmNlNcJm02yV', 'main_product_selector3');
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('content').innerText = '';
        document.getElementById('authorize_button').innerText = 'Authorize';
        document.getElementById('signout_button').style.visibility = 'hidden';
      }
    }

    async function listFilesInFolder(folderId, selectorId) {
      let response;
      try {
        response = await gapi.client.drive.files.list({
          'q': `'${folderId}' in parents and mimeType contains 'image/'`,
          'fields': 'files(id, name, mimeType, thumbnailLink)',
        });
        console.log(response);
      } catch (err) {
        document.getElementById('content').innerText = err.message;
        console.error(err);
        return;
      }
      const items = response.result.files;
      const selector = document.getElementById(selectorId);
      selector.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.text = '없음';
      defaultOption.value = '';
      selector.appendChild(defaultOption);

      items.forEach((item) => {
        const option = document.createElement('option');
        option.text = item.name;
        option.value = item.thumbnailLink;
        selector.appendChild(option);
      });
    }

    function handleGiftTypeChange(index) {
      const giftType = document.getElementById(`gift_type_selector${index}`).value;
      if (giftType) {
        const folderId = giftTypeToFolderId[giftType];
        listFilesInFolder(folderId, `gift_product_selector${index}`);
      } else {
        document.getElementById(`gift_product_selector${index}`).innerHTML = '';
      }
    }

    function displayProduct(index, type) {
      const selector = document.getElementById(`${type}_product_selector${index}`);
      const ratioSelector = document.getElementById(`${type}_product_ratio${index}`);
      const thumbnailLink = selector.value;
      const ratio = parseInt(ratioSelector.value, 10) / 100;
      const imageArray = type === 'main' ? mainProductImages : giftProductImages;
      if (thumbnailLink) {
        imageArray[index - 1] = new Image();
        imageArray[index - 1].src = thumbnailLink;
        imageArray[index - 1].onload = () => drawCanvas();
        imageArray[index - 1].ratio = ratio;
      } else {
        imageArray[index - 1] = null;
        drawCanvas();
      }
      if (type === 'gift') {
        const quantityInput = document.getElementById(`gift_quantity${index}`);
        giftQuantities[index - 1] = quantityInput.value || 0;
      }
    }

    function selectProduct(index, type) {
      const button = event.target;

      // 모든 버튼을 초기 상태로 되돌리기
      document.querySelectorAll('#main_product button, #gift_product button').forEach(btn => {
        if (btn.innerText === '위치 변경중') {
          btn.innerText = '위치 수정';
          btn.style.backgroundColor = '';
        }
      });

      if (isEditing && selectedImageIndex === index - 1 + (type === 'main' ? 0 : 3)) {
        isEditing = false;
        selectedImageIndex = null;
        button.innerText = '위치 수정';
        button.style.backgroundColor = '';
        document.getElementById('selection_message').innerText = '';
      } else {
        isEditing = true;
        selectedImageIndex = index - 1 + (type === 'main' ? 0 : 3);
        const productType = type === 'main' ? '본품' : '증정품';
        document.getElementById('selection_message').innerText = `${productType} 이미지 ${index}이 선택되었습니다!`;

        // 선택된 버튼만 변경
        button.innerText = '위치 변경중';
        button.style.backgroundColor = 'lightblue';
      }
      drawCanvas();
    }


    function drawCanvas() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      mainProductImages.forEach((image, index) => {
        if (image) {
          const pos = mainProductPositions[index];
          const scaledWidth = image.width * image.ratio;
          const scaledHeight = image.height * image.ratio;
          const x = pos.x - scaledWidth / 2;
          const y = pos.y - scaledHeight / 2;
          ctx.drawImage(image, x, y, scaledWidth, scaledHeight);

          if (selectedImageIndex === index) {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 5;
            ctx.strokeRect(x, y, scaledWidth, scaledHeight);
          }
        }
      });

      giftProductImages.forEach((image, index) => {
        if (image) {
          const pos = giftProductPositions[index];
          const scaledWidth = image.width * image.ratio;
          const scaledHeight = image.height * image.ratio;
          const x = pos.x - scaledWidth / 2;
          const y = pos.y - scaledHeight / 2;
          ctx.drawImage(image, x, y, scaledWidth, scaledHeight);

          if (selectedImageIndex === index + 3) {
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 5;
            ctx.strokeRect(x, y, scaledWidth, scaledHeight);
          }

          const quantity = giftQuantities[index];
          if (quantity > 0) {
            const text = `X ${quantity}`;
            ctx.fillStyle = '#000';
            ctx.font = '16px Arial';
            const textWidth = ctx.measureText(text).width;
            const textX = pos.x - textWidth / 2; // 텍스트의 중앙을 이미지의 중앙에 맞춤
            const textY = pos.y - scaledHeight / 2 - 10;
            ctx.fillText(text, textX, textY);
          }
        }
      });
    }


    function resetAll() {
      mainProductImages = [null, null, null];
      giftProductImages = [null, null, null];
      giftQuantities = [0, 0, 0];
      selectedImageIndex = null;
      isEditing = false;
      document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
      document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
      const mainProductRatios = [document.getElementById('main_product_ratio1'), document.getElementById('main_product_ratio2'), document.getElementById('main_product_ratio3')];
      const giftProductRatios = [document.getElementById('gift_product_ratio1'), document.getElementById('gift_product_ratio2'), document.getElementById('gift_product_ratio3')];
      mainProductRatios.forEach((select) => {
        select.innerHTML = generateRatioOptions(100);
      });
      giftProductRatios.forEach((select) => {
        select.innerHTML = generateRatioOptions(70);
      });
      document.getElementById('selection_message').innerText = '';

        // 본품 & 증정품 영역의 버튼만 선택
      const mainProductButtons = document.querySelectorAll('#main_product button');
      const giftProductButtons = document.querySelectorAll('#gift_product button');

      // 각 버튼 텍스트를 '위치 수정'으로 초기화
      mainProductButtons.forEach(btn => { 
        if (btn.innerText !== '확인'){ 
          btn.innerText = '위치 수정';
          btn.style.backgroundColor = ''; 
        }
      });
      giftProductButtons.forEach(btn => { 
        if (btn.innerText !== '확인'){ 
          btn.innerText = '위치 수정';
          btn.style.backgroundColor = ''; 
        }
      });

      drawCanvas();
    }

    function generateRatioOptions(defaultValue) {
      let options = '';
      for (let i = 10; i <= 200; i += 10) {
        options += `<option value="${i}" ${i === defaultValue ? 'selected' : ''}>${i}%</option>`;
      }
      return options;
    }

    function handleKeyDown(event) {
      // Prevent page scrolling only for arrow keys and Enter key
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(event.key)) {
        event.preventDefault();
      }

      if (isEditing && selectedImageIndex !== null) {
        const imageArray = selectedImageIndex < 3 ? mainProductImages : giftProductImages;
        const index = selectedImageIndex < 3 ? selectedImageIndex : selectedImageIndex - 3;
        const positions = selectedImageIndex < 3 ? mainProductPositions : giftProductPositions;
        const pos = positions[index];
        switch (event.key) {
          case 'ArrowUp':
            pos.y -= 5;
            break;
          case 'ArrowDown':
            pos.y += 5;
            break;
          case 'ArrowLeft':
            pos.x -= 5;
            break;
          case 'ArrowRight':
            pos.x += 5;
            break;
          case 'Enter':
            isEditing = false;
            selectedImageIndex = null;
            document.getElementById('selection_message').innerText = '';

            // 모든 "위치 수정중" 버튼을 "위치 수정" 버튼으로 변경
            document.querySelectorAll('#main_product button, #gift_product button').forEach(btn => {
              if (btn.innerText === '위치 변경중') {
                btn.innerText = '위치 수정';
                btn.style.backgroundColor = '';
              }
            });
            break;
        }
        drawCanvas();
      }
    }

    document.addEventListener('keydown', handleKeyDown);

    document.addEventListener('DOMContentLoaded', () => {
      const mainProductRatios = [document.getElementById('main_product_ratio1'), document.getElementById('main_product_ratio2'), document.getElementById('main_product_ratio3')];
      const giftProductRatios = [document.getElementById('gift_product_ratio1'), document.getElementById('gift_product_ratio2'), document.getElementById('gift_product_ratio3')];

      mainProductRatios.forEach((select, index) => {
        select.innerHTML = generateRatioOptions(100);
      });

      giftProductRatios.forEach((select, index) => {
        select.innerHTML = generateRatioOptions(70);
      });
    });
  </script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>